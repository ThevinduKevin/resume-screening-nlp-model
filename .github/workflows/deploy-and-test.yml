name: Multi-Cloud ML Benchmark

on:
  workflow_dispatch:

jobs:
  # ===========================================
  # AWS JOB
  # ===========================================
  aws:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Generate SSH key pair
        run: |
          mkdir -p ~/.ssh
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N "" -q
          chmod 600 ~/.ssh/id_rsa
          echo "SSH_PUBLIC_KEY=$(cat ~/.ssh/id_rsa.pub)" >> $GITHUB_ENV

      - name: Deploy AWS Infrastructure
        working-directory: terraform/aws
        run: |
          terraform init
          terraform apply -auto-approve -var="ssh_public_key=$SSH_PUBLIC_KEY"

      - name: Setup SSH known hosts
        run: |
          cd terraform/aws
          TARGET_IP=$(terraform output -raw public_ip)
          cd ../..
          ssh-keyscan -H $TARGET_IP >> ~/.ssh/known_hosts || true

      - name: Run Locust tests
        env:
          RESULTS_DIR: results/aws
        run: |
          set -e

          mkdir -p $RESULTS_DIR

          cd terraform/aws
          TARGET_IP=$(terraform output -raw public_ip)
          cd ../..

          echo "Target IP: $TARGET_IP"
          echo "Waiting 60s for EC2 to be ready for SSH..."
          sleep 60

          echo "=== Testing SSH ==="
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$TARGET_IP "echo SSH_OK"

          echo "=== Waiting for user_data.sh to complete ==="
          for i in {1..30}; do
            if ssh -i ~/.ssh/id_rsa ubuntu@$TARGET_IP "sudo grep -q 'Setup complete' /var/log/user_data.log 2>/dev/null"; then
              echo "user_data.sh completed!"
              break
            fi
            echo "Attempt $i/30: user_data still running, waiting 10s..."
            sleep 10
          done

          echo "=== Checking ML API service status ==="
          ssh -i ~/.ssh/id_rsa ubuntu@$TARGET_IP << 'EOF'
            echo "--- user_data log (last 30 lines) ---"
            sudo tail -30 /var/log/user_data.log || true
            
            echo "--- ml-api service status ---"
            sudo systemctl status ml-api || true
            
            if ! sudo systemctl is-active --quiet ml-api; then
              echo "Service not running, attempting restart..."
              sudo systemctl restart ml-api || true
              sleep 5
            fi
            
            echo "--- Listening on port 8000 ---"
            ss -tulpn | grep 8000 || echo "Port 8000 not yet listening"
          EOF

          echo "=== Waiting for API to be ready ==="
          for i in {1..12}; do
            if curl -sf http://$TARGET_IP:8000/health > /dev/null 2>&1; then
              echo "API is ready!"
              break
            fi
            echo "Attempt $i/12: API not ready, waiting 10s..."
            sleep 10
          done

          echo "=== Testing API health endpoint ==="
          curl -f http://$TARGET_IP:8000/health

          python3 -m venv locust-env
          source locust-env/bin/activate

          pip install --upgrade pip
          pip install locust psutil zope-event

          python scripts/collect_metrics.py &

          export TARGET_IP=$TARGET_IP
          bash scripts/run_locust.sh

          mv results/locust_*.csv $RESULTS_DIR/ || true
          mv results/locust_*.log $RESULTS_DIR/ || true
          mv results/system_metrics.csv $RESULTS_DIR/ || true

      - name: Destroy AWS Infrastructure
        if: always()
        working-directory: terraform/aws
        run: terraform destroy -auto-approve -var="ssh_public_key=$SSH_PUBLIC_KEY"

      - name: Upload AWS results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: aws-results
          path: results/aws/

  # ===========================================
  # AZURE JOB
  # ===========================================
  azure:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Extract Azure Subscription ID
        run: |
          SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')
          echo "ARM_SUBSCRIPTION_ID=$SUBSCRIPTION_ID" >> $GITHUB_ENV
          echo "AZURE_SUBSCRIPTION_ID=$SUBSCRIPTION_ID" >> $GITHUB_ENV

      - name: Generate SSH key pair
        run: |
          mkdir -p ~/.ssh
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N "" -q
          chmod 600 ~/.ssh/id_rsa
          echo "SSH_PUBLIC_KEY=$(cat ~/.ssh/id_rsa.pub)" >> $GITHUB_ENV

      - name: Cleanup existing Azure resources
        run: |
          # Force delete resource group and wait for complete deletion
          echo "Checking for existing resource group..."
          for attempt in 1 2 3; do
            if az group exists --name ml-benchmark-rg | grep -q true; then
              echo "Attempt $attempt: Resource group exists, deleting..."
              az group delete --name ml-benchmark-rg --yes --force-deletion-types Microsoft.Compute/virtualMachines 2>/dev/null || true
              echo "Waiting 60s for deletion to complete..."
              sleep 60
            else
              echo "Resource group does not exist"
              break
            fi
          done
          
          # Final verification - ensure it's really gone
          if az group exists --name ml-benchmark-rg | grep -q true; then
            echo "ERROR: Resource group still exists after 3 attempts!"
            echo "Waiting additional 120s..."
            sleep 120
          fi
          echo "Cleanup complete, proceeding with deployment..."

      - name: Deploy Azure Infrastructure
        working-directory: terraform/azure
        run: |
          # Remove any stale terraform state
          rm -rf .terraform terraform.tfstate* .terraform.lock.hcl || true
          
          terraform init
          terraform apply -auto-approve \
            -var="ssh_public_key=$SSH_PUBLIC_KEY" \
            -var="subscription_id=$ARM_SUBSCRIPTION_ID"

      - name: Setup SSH known hosts
        run: |
          cd terraform/azure
          TARGET_IP=$(terraform output -raw public_ip)
          cd ../..
          ssh-keyscan -H $TARGET_IP >> ~/.ssh/known_hosts || true

      - name: Run Locust tests
        env:
          RESULTS_DIR: results/azure
        run: |
          set -e

          mkdir -p $RESULTS_DIR

          cd terraform/azure
          TARGET_IP=$(terraform output -raw public_ip)
          cd ../..

          echo "Target IP: $TARGET_IP"
          echo "Waiting 60s for VM to be ready for SSH..."
          sleep 60

          echo "=== Testing SSH ==="
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa azureuser@$TARGET_IP "echo SSH_OK"

          echo "=== Waiting for startup.sh to complete ==="
          for i in {1..30}; do
            if ssh -i ~/.ssh/id_rsa azureuser@$TARGET_IP "sudo grep -q 'Setup complete' /var/log/startup.log 2>/dev/null"; then
              echo "startup.sh completed!"
              break
            fi
            echo "Attempt $i/30: startup still running, waiting 10s..."
            sleep 10
          done

          echo "=== Checking ML API service status ==="
          ssh -i ~/.ssh/id_rsa azureuser@$TARGET_IP << 'EOF'
            echo "--- startup log (last 30 lines) ---"
            sudo tail -30 /var/log/startup.log || true
            
            echo "--- ml-api service status ---"
            sudo systemctl status ml-api || true
            
            if ! sudo systemctl is-active --quiet ml-api; then
              echo "Service not running, attempting restart..."
              sudo systemctl restart ml-api || true
              sleep 5
            fi
            
            echo "--- Listening on port 8000 ---"
            ss -tulpn | grep 8000 || echo "Port 8000 not yet listening"
          EOF

          echo "=== Waiting for API to be ready ==="
          for i in {1..12}; do
            if curl -sf http://$TARGET_IP:8000/health > /dev/null 2>&1; then
              echo "API is ready!"
              break
            fi
            echo "Attempt $i/12: API not ready, waiting 10s..."
            sleep 10
          done

          echo "=== Testing API health endpoint ==="
          curl -f http://$TARGET_IP:8000/health

          python3 -m venv locust-env
          source locust-env/bin/activate

          pip install --upgrade pip
          pip install locust psutil zope-event

          python scripts/collect_metrics.py &

          export TARGET_IP=$TARGET_IP
          bash scripts/run_locust.sh

          mv results/locust_*.csv $RESULTS_DIR/ || true
          mv results/locust_*.log $RESULTS_DIR/ || true
          mv results/system_metrics.csv $RESULTS_DIR/ || true

      - name: Destroy Azure Infrastructure
        if: always()
        working-directory: terraform/azure
        run: |
          terraform init
          terraform destroy -auto-approve \
            -var="ssh_public_key=$SSH_PUBLIC_KEY" \
            -var="subscription_id=$ARM_SUBSCRIPTION_ID"

      - name: Upload Azure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: azure-results
          path: results/azure/

  # ===========================================
  # GCP JOB
  # ===========================================
  gcp:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Generate SSH key pair
        run: |
          mkdir -p ~/.ssh
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N "" -q
          chmod 600 ~/.ssh/id_rsa
          echo "SSH_PUBLIC_KEY=$(cat ~/.ssh/id_rsa.pub)" >> $GITHUB_ENV

      - name: Deploy GCP Infrastructure
        working-directory: terraform/gcp
        run: |
          terraform init
          terraform apply -auto-approve \
            -var="ssh_public_key=$SSH_PUBLIC_KEY" \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}"

      - name: Setup SSH known hosts
        run: |
          cd terraform/gcp
          TARGET_IP=$(terraform output -raw public_ip)
          cd ../..
          ssh-keyscan -H $TARGET_IP >> ~/.ssh/known_hosts || true

      - name: Run Locust tests
        env:
          RESULTS_DIR: results/gcp
        run: |
          set -e

          mkdir -p $RESULTS_DIR

          cd terraform/gcp
          TARGET_IP=$(terraform output -raw public_ip)
          cd ../..

          echo "Target IP: $TARGET_IP"
          echo "Waiting 60s for VM to be ready for SSH..."
          sleep 60

          echo "=== Testing SSH ==="
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$TARGET_IP "echo SSH_OK"

          echo "=== Waiting for startup.sh to complete ==="
          for i in {1..30}; do
            if ssh -i ~/.ssh/id_rsa ubuntu@$TARGET_IP "sudo grep -q 'Setup complete' /var/log/startup.log 2>/dev/null"; then
              echo "startup.sh completed!"
              break
            fi
            echo "Attempt $i/30: startup still running, waiting 10s..."
            sleep 10
          done

          echo "=== Checking ML API service status ==="
          ssh -i ~/.ssh/id_rsa ubuntu@$TARGET_IP << 'EOF'
            echo "--- startup log (last 30 lines) ---"
            sudo tail -30 /var/log/startup.log || true
            
            echo "--- ml-api service status ---"
            sudo systemctl status ml-api || true
            
            if ! sudo systemctl is-active --quiet ml-api; then
              echo "Service not running, attempting restart..."
              sudo systemctl restart ml-api || true
              sleep 5
            fi
            
            echo "--- Listening on port 8000 ---"
            ss -tulpn | grep 8000 || echo "Port 8000 not yet listening"
          EOF

          echo "=== Waiting for API to be ready ==="
          for i in {1..12}; do
            if curl -sf http://$TARGET_IP:8000/health > /dev/null 2>&1; then
              echo "API is ready!"
              break
            fi
            echo "Attempt $i/12: API not ready, waiting 10s..."
            sleep 10
          done

          echo "=== Testing API health endpoint ==="
          curl -f http://$TARGET_IP:8000/health

          python3 -m venv locust-env
          source locust-env/bin/activate

          pip install --upgrade pip
          pip install locust psutil zope-event

          python scripts/collect_metrics.py &

          export TARGET_IP=$TARGET_IP
          bash scripts/run_locust.sh

          mv results/locust_*.csv $RESULTS_DIR/ || true
          mv results/locust_*.log $RESULTS_DIR/ || true
          mv results/system_metrics.csv $RESULTS_DIR/ || true

      - name: Destroy GCP Infrastructure
        if: always()
        working-directory: terraform/gcp
        run: |
          terraform init
          terraform destroy -auto-approve \
            -var="ssh_public_key=$SSH_PUBLIC_KEY" \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}"

      - name: Upload GCP results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gcp-results
          path: results/gcp/
